<?php

namespace zero\server\http;

use zero\Container;
use zero\server\BaseServer;
use zero\server\tcp\TcpServer;

/**
 * Class HttpServer
 * @package zero\server
 */
class HttpServer extends BaseServer
{
    /**
     * 启动服务
     */
    public function run()
    {
        // 实例化 swoole 的 http 服务
        $this->server = new \Swoole\Http\Server($this->config['http']['host'], $this->config['http']['port']);
        $this->server->set($this->config['http']['setting']);

        if (isset($this->config['http']['enable_tcp']) && true === $this->config['http']['enable_tcp']) {
            (new TcpServer())->listen($this->server, $this->config['tcp']);
        }

        // 注册事件回调函数
        $this->server->on('start', [$this, 'start']);
        $this->server->on('workerStart', [$this, 'workerStart']);
        $this->server->on('request', [$this, 'request']);

        // 启动 http 服务器
        $this->server->start();
    }

    /**
     * @param $request
     * @param $response
     * @throws \Exception
     */
    public function request($request, $response)
    {
        // chrome 请求两次问题
        if ($request->server['path_info'] == '/favicon.ico' || $request->server['request_uri'] == '/favicon.ico') {
            $response->end();
            return;
        }
        // 路由解析
        $body = Container::get('route')->dispatch($request->server['request_method'], $request->server['request_uri']);
        // 响应请求
        $response->header("Content-Type", "application/json; charset=utf-8");
        $response->end(is_string($body) ? $body : json_encode($body));
    }

    public function start()
    {
        parent::start(); // TODO: Change the autogenerated stub

        echo " *********************************************************************" . PHP_EOL;
        echo sprintf("*  http  |  Listen: %s:%d, type: http, worker: %d  ",
                $this->config['http']['host'],
                $this->config['http']['port'],
                $this->config['http']['setting']['worker_num']
            ) . PHP_EOL;
        if (isset($this->config['http']['enable_tcp']) && true === $this->config['http']['enable_tcp']) {
            echo sprintf("*  tcp   |  Listen: %s:%d, type: tcp , worker: %d  ",
                    $this->config['tcp']['host'],
                    $this->config['tcp']['port'],
                    $this->config['tcp']['setting']['worker_num']
                ) . PHP_EOL;
            echo " *********************************************************************" . PHP_EOL;
        } else {
            echo " *********************************************************************" . PHP_EOL;
        }
    }

}
